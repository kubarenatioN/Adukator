<ng-container *ngIf="isUserOwnPage !== null; else loader">
	<div class="page" *ngIf="isUserOwnPage === true; else noAccess">

		<ng-container *ngIf="user$ | async as user">
			<div class="profile-banner">
				<div class="row">
					<img
						crossorigin="anonymous"
						referrerpolicy="no-referrer"
						[src]="user.photo"
						alt="User Avatar"
					/>
					<h1>{{ user.username }}</h1>
				</div>
				<h3>Ранг: {{ user.permission }}</h3>
				<div *ngIf="userTrainingProfile$ | async as userTrainingProfile">
					<div class="competencies">
						<h4>Компетенции</h4>
						<ul
						class="comps-list"
							*ngIf="
								userTrainingProfile.competencies.length > 0;
								else noItems
							"
						>
							<li class="competency-item" *ngFor="let comp of userTrainingProfile.competencies">
								{{ comp | competency }}
							</li>
						</ul>
						<div class="competencies__request">
							<p class="info-text">Вы можете активировать внешние компетенции.</p>
							<button 
							mat-raised-button 
							color="primary"
							(click)="requestCompetencies(user)">Запросить компетенции</button>

							<div class="competencies__request-list">
								<ng-container *ngIf="userCompetenciesRequests$ | async as compsRequests">
									<div class="competencies__request-item" *ngFor="let req of compsRequests; let i = index">
										<div class="competencies__request-item-header">
											Запрос {{ req.uuid }}
										</div>
										<div class="competencies__request-item-body">
											<div class="competencies__request-comps-list">
												<span 
												class="competency-item"
												*ngFor="let c of req.competencies">{{ c | competency }}</span>
											</div>
											<span></span>
											<!-- <span>{{ req.status }}</span> -->
											<div class="competencies__request-actions">
												<button 
												*ngIf="req.status === 'pending'"
												mat-raised-button
												(click)="cancelCompsRequest(req.uuid)">Отменить</button>
											</div>
										</div>
									</div>
								</ng-container>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="teacher-perms-request__wrapper">
				<ng-container *ngIf="user.role !== 'admin'">
					<ng-container *ngIf="userTeacherPermsRequest$ | async as request; else becomeTeacher">
						<div class="teacher-perms-request">
							<h3>
								Заявка на получение прав преподавателя
							</h3>
							<p>
								Статус: {{ request.status }}
							</p>
							<button 
							mat-raised-button
							*ngIf="request.status === 'pending'" 
							(click)="cancelTeacherPermsRequest(request)">Отозвать заявку</button>
							<button 
							mat-raised-button
							*ngIf="request.status === 'rejected'" 
							(click)="onRequestTeacherPermission(user)">Отправить повторно</button>
						</div>
					</ng-container>
					<ng-template #becomeTeacher>
						<p class="info-text">Вы можете стать преподавателем NovaLearn.</p>
						<button 
						mat-raised-button 
						color="primary" 
						(click)="onRequestTeacherPermission(user)">Стать преподавателем</button>
					</ng-template>
				</ng-container>
			</div>
			
			<div class="footer">
				<button mat-raised-button (click)="logOut()">Выйти</button>
			</div>

		</ng-container>

	</div>
</ng-container>


<ng-template #studentPermissionProfile>
	<div class="courses-section">
		<h2>Мои курсы</h2>

		<div *ngIf="studentApprovedCourses$ | async as trainings; else loader">
			<h3>Зачислен</h3>
			<ng-container *ngIf="trainings.length > 0; else noItems">
				<div class="courses-list">
					<ng-container
						*ngFor="let training of trainings"
						[ngTemplateOutlet]="approvedCourse"
						[ngTemplateOutletContext]="{ training }"
					></ng-container>
				</div>
			</ng-container>
		</div>

		<div *ngIf="studentPendingCourses$ | async as trainings; else loader">
			<h3>В ожидании</h3>
			<ng-container *ngIf="trainings.length > 0; else noItems">
				<div class="courses-list">
					<ng-container
						*ngFor="let training of trainings"
						[ngTemplateOutlet]="pendingCourse"
						[ngTemplateOutletContext]="{ training }"
					></ng-container>
				</div>
			</ng-container>
		</div>
	</div>

	<h2>Еще какой-нибудь раздел в профиле студента</h2>
</ng-template>

<ng-template #pendingCourse let-training="training">
	<a
		class="course-item"
		[routerLink]="['/app/learn/course/overview', training.uuid]"
	>
		<p>
			{{ training.course.title }}
		</p>
		<span class="course-status"> Pending </span>
	</a>
</ng-template>

<ng-template #approvedCourse let-training="training">
	<a
		class="course-item"
		[routerLink]="['/app/student/training', training.uuid]"
	>
		<p>
			{{ training.course.title }}
		</p>
		<span class="course-status"> Approved </span>
	</a>
</ng-template>

<ng-template #loader> Loading... </ng-template>

<ng-template #noItems> Здесь пусто ;( </ng-template>
<ng-template #noAccess>
	<p>
		Нет доступа
	</p>
</ng-template>
